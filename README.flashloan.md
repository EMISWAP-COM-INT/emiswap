# Защита протокола от атак типа Harvesting FlashLoan

Атака была проведена 26 октября 2020 года на бирже Harvest Finance. В результате манипуляции курсами валют в сделках с большим объемом средств 
с использованием уязвимости протокола биржи было выведено порядка $33.8M активов (3,2% всех активов биржи).

Процесс атаки был реконструирован и определены способы избежать его повторения на нашей бирже.

Ход атаки подробно описан [здесь](https://medium.com/harvest-finance/harvest-flashloan-economic-attack-post-mortem-3cf900d65217).

## Реализация атаки
Способ реализации атаки:
 - атака была тщательно спланирована и сконструирована,
 - атака проведена с использованием большой суммы заёмных средств ($18.3 M USDT и $50M USDC) для максимального увеличения плеча торгов.
 - атака проведена контрактом [0xc6028a9fa486f52efd2b95b949ac630d287ce0af](https://etherscan.io/address/0xc6028a9fa486f52efd2b95b949ac630d287ce0af).
 - каждый этап выполнялся в рамках одной транзакции внутри контракта.
 - была использована известная но недооцененная Harvest Finance уязвимость в виде арбитража курсов валют и деривативов между собственной биржей и 
   другими биржами (установлен высокий коэффициент отсечки разницы курсов в 3%, когда для атаки хватило 1%).

## Основные причины успешной атаки

Основными причинами успешной реализации атаки стали:

 1. Реализация расчета курсов пар валют в реальном времени
 2. Хранение части активов в нижележащих хранилищах других бирж, что открывает возможность использовать разницу курсов с целью манипуляции на больших объемах торгов.

Security team Harvest Finance выпустила рекомендации для реализации протокола, защищённого от такого типа атак (в основном, для закрытия возможности 
многократного изменения курсов в рамках одной транзакции). В их числе:

 1. Реализация принципа commit-and-reveal, когда депозит средств пользователя и получения им соответствующего количества LP-токенов разнесено по времени 
    и транзакциям, что требует определенной адаптации логики реализации UI/UX.
 2. Более тщательное регулирование механизма проверки арбитража при работе с деривативами (в случае с Harvest Finance отсечка была установлена на 3% изменения курса, а
    в ходе атаки курс менялся всего на 1%, однако, этого хватило, чтобы при многократных повторениях операций в рамках одной транзакции вывести $33.8M)
 3. Вывод средств только в виде реальных базовых валют (без деривативов) для пулов, использующих деривативы (т.е. использовать только пулы с 
    базовыми токенами, а не пулы с деривативами).
 4. Использование оракулов для определения цены активов. Это автоматически предполагает некоторую задержку в изменениях курсов и исключению возможности манипуляции
    курсами подобно рассмотренной атаке.

## Защита Emiswap от подобной атаки

Наша реализация протокола (EmiSwap) использует в своей работе два из четырёх указанных механизмов плюс один, заимствованных у Mooniswap:

 1. Мы реализуем концепцию виртуального баланса и периода задержки (decay period), то есть изменение курса пула только после истечения определённого периода задержки
    после изменения ликвидности пула.
 2. Использование оракулов для определения курсов валют пула.
 3. Мы не используем деривативы для организации собственных пулов.
 4. Вследствие п. 3 у нас не создаётся ситуации арбитража между нашими пулами и пулами бирж деривативов.
